#!/bin/bash

################################################################################
# APPIAN UPGRADE MAINTENANCE SCRIPT
# Target Version: 25.3
################################################################################

# ==============================================================================
# PHASE 1: PRE-UPGRADE CHECKLIST (MANUAL)
# ==============================================================================
# [ ] 1. Disable MQ Manager: "COMM_Integration" -> Constant 'COMM_IN_C_isActiveMQListenerManager' -> False
# [ ] 2. Cancel Listeners: "COMM_Integration" -> Monitor -> Filter 'Active' -> Search 'MQListener'
# [ ] 3. Release Locks: Cancel Instance -> Start Node 'Execute SP RELEASE LOCK'
# [ ] 4. Verify Files: Ensure Binaries and Licenses are in /share/appian/install_binaries/
# ==============================================================================

## 1. SET VARIABLES & ENVIRONMENT
APPIAN_HOME=/COLO/appian
APP_SHARE=/share/appian
APPIAN_REPO=$APP_SHARE/appianrepository
APP_USER=$(stat -c %U $APPIAN_HOME)
APP_GROUP=$(stat -c %G $APPIAN_HOME)

# Identify current version and environment
VER=$(sed -n 's/build\.version=//p' $APPIAN_HOME/conf/build.info | cut -d. -f1-2)
f=$(basename $(find ${APPIAN_REPO}/conf -name "tomcatResources.xml*" | grep -v example))
ENV_NAME=${f##*.}

# Define Installation Binary (Update this path before running)
INSTALL_BIN=$APP_SHARE/install_binaries/setupLinux64_appian-25.3.361.0.bin
CONFIG_ZIP=$(ls $APP_SHARE/install_binaries/configure-*.zip | head -n 1)

echo "--- ENVIRONMENT SUMMARY ---"
echo "ENV NAME:     $ENV_NAME"
echo "CURRENT VER:  $VER"
echo "APP USER:     $APP_USER"
echo "BINARY:       $INSTALL_BIN"
echo "---------------------------"

read -p "CONFIRM: Is the environment name correct? (y/n) " -n 1 -r
echo
[[ ! $REPLY =~ ^[Yy]$ ]] && exit 1

## 2. SET PERMISSIONS & SWITCH USER
chown -R $APP_USER:$APP_GROUP /share/appian/install_binaries/
chmod +x /share/appian/install_binaries/setupLinux64_*

# Ensure we are running as the Appian user
if [ "$(whoami)" != "$APP_USER" ]; then
    echo "Switching to $APP_USER..."
    exec sudo su - "$APP_USER" -s /bin/bash "$0" "$@"
fi

## 3. STOP SERVICES & BACKUP
echo "Stopping Appian Services..."
$APPIAN_HOME/tomcat/apache-tomcat/bin/stop-appserver.sh
$APPIAN_HOME/search-server/bin/stop.sh
$APPIAN_HOME/data-server/bin/stop.sh
$APPIAN_HOME/services/bin/stop.sh -p appian123 -c

echo "CRITICAL: Manual Backup Required Now!"
echo "- Database snapshots for all 'appian_business_*' schemas"
echo "- Storage snapshots"
read -p "Have backups been completed? (y/n) " -n 1 -r
echo
[[ ! $REPLY =~ ^[Yy]$ ]] && exit 1

## 4. PREPARE DIRECTORIES & INSTALL
# Backup current Repo
if [[ ! -d ${APPIAN_REPO}-${VER} ]] ; then
    mv ${APPIAN_REPO} ${APPIAN_REPO}-${VER} && mkdir ${APPIAN_REPO}
else
    echo "Warning: ${APPIAN_REPO}-${VER} already exists. Skipping move."
fi

# Backup current Home and Install
if [[ ! -d ${APPIAN_HOME}-${VER} ]] ; then
    mv ${APPIAN_HOME} ${APPIAN_HOME}-${VER} && mkdir ${APPIAN_HOME}
    echo "Running Silent Installer..."
    $INSTALL_BIN --mode silent --prefix $APPIAN_HOME
else
    echo "ERROR: ${APPIAN_HOME}-${VER} already exists. Installation aborted to prevent overwrite."
    exit 1
fi

## 5. CONFIGURATION
mkdir -p ${APPIAN_HOME}/_admin/_scripts/configure
unzip -q $CONFIG_ZIP -d $APPIAN_HOME/_admin/_scripts/configure/

# Run Appian Config Tasks
${APPIAN_HOME}/_admin/_scripts/configure/configure.sh -silent task=createRepository repositoryDir=$APPIAN_REPO
${APPIAN_HOME}/_admin/_scripts/configure/configure.sh -silent task=registerEnvironment environmentName=$ENV_NAME
cp -rp ${APPIAN_REPO}-${VER}/* ${APPIAN_REPO}

# Update Search Server Passwords
SS_PWD=123456
for CONF in "$APPIAN_REPO/search-server/conf/custom.properties.$ENV_NAME" "$APPIAN_REPO/conf/passwords.properties.$ENV_NAME"; do
    if [ -f "$CONF" ]; then
        sed -i "s/conf.search-server.user.appian.password=.*/conf.search-server.user.appian.password=$SS_PWD/" "$CONF"
        sed -i "s/conf.password.SearchServer=.*/conf.password.SearchServer=$SS_PWD/" "$CONF"
    fi
done

# Cleanup & Deploy
find $APPIAN_REPO -type f \( -name "README*" -o -name "*.example" \) -delete
${APPIAN_HOME}/_admin/_scripts/configure/configure.sh -silent task=deployAppianConfigurations environmentName=$ENV_NAME

## 6. DATA SYNC (RSYNC FUNCTION)
safe_sync() {
    echo "Syncing: $1..."
    rsync -vaz --progress --partial "$1" "$2" --dry-run >/dev/null 2>&1
    if [ $? -eq 0 ]; then
        rsync -vaz --progress --partial "$1" "$2"
    else
        echo "ERROR: Dry run failed for $1. Check permissions."
    fi
}

safe_sync "${APPIAN_HOME}-${VER}/_admin/" "${APPIAN_HOME}/_admin/"
safe_sync "${APPIAN_HOME}-${VER}/data-server/data" "${APPIAN_HOME}/data-server/"
safe_sync "${APPIAN_HOME}-${VER}/search-server/data" "${APPIAN_HOME}/search-server/"
safe_sync "${APPIAN_HOME}-${VER}/services/data/" "${APPIAN_HOME}/services/data/"

# Symlink Server Dirs
SERVER_DIRS=("archived-process" "msg" "channels/gw1" "collaboration/gw1" "forums/gw1" "notifications/gw1" "personalization/gw1" "portal/gw1" "process/design/gw1")
for d in "${SERVER_DIRS[@]}"; do
    rm -rf "${APPIAN_HOME}/server/${d}"
    ln -s "${APP_SHARE}/server/${d}" "${APPIAN_HOME}/server/${d}"
done

# Sync Frontend
FRONTEND=$(grep HostName ~/.ssh/config | awk '{print $2}')
rsync -vaz --delete /COLO/appian/deployment/web.war/ $APP_USER@$FRONTEND:/var/www/html/suite/

# Restore Certs
cp -Rp ${APPIAN_HOME}-${VER}/java/jre/lib/security/cacerts ${APPIAN_HOME}/java/jre/lib/security/ 2>/dev/null || \
cp -Rp ${APPIAN_HOME}-${VER}/java/jre/lib/security/cacerts ${APPIAN_HOME}/java/lib/security/

## 7. STARTUP & VALIDATION
echo "Starting Engines..."
/COLO/appian/services/bin/start.sh -p appian123 -s all
/COLO/appian/data-server/bin/start.sh
/COLO/appian/search-server/bin/start.sh

echo "Starting Primary Tomcat... monitoring logs..."
/COLO/appian/tomcat/apache-tomcat/bin/start-appserver.sh

tail -f /COLO/appian/logs/tomcat-stdOut.log

################################################################################
# ROLLBACK PROCEDURES
# 1. rm -rf $APPIAN_HOME && mv ${APPIAN_HOME}-${VER} $APPIAN_HOME
# 2. rm -rf $APPIAN_REPO && mv ${APPIAN_REPO}-${VER} $APPIAN_REPO
# 3. Re-sync frontend web data from the restored $APPIAN_HOME
################################################################################